---
// src/pages/[lang]/portfolio/page/[page].astro

// ----- Components

import BaseLayout from '../../../../layouts/BaseLayout.astro';
import Banner from '../../../../components/sections/Banner.astro';
import CallToAction from '../../../../components/sections/CallToAction.astro';
import PortfolioCard from '../../../../components/ui/PortfolioCard.astro';
import Pagination from '../../../../components/ui/Pagination.astro';

// ----- Image

import PortfolioBanner from '../../../../assets/images/bg/bg-portfolio.webp';
import CTA from '../../../../assets/images/cta.webp';

import { type CollectionEntry } from 'astro:content';

// ----- Function

// Parámetros de ruta
const { page = '1', lang = 'es' } = Astro.params;
const currentPage: number = typeof page === 'string' ? parseInt(page, 10) : 1;

// Cargar projects desde content/projects/
const projectsImport = import.meta.glob('../../../../content/projects/*.mdx');
const projectEntries = Object.entries(projectsImport);

// Tipar los módulos como CollectionEntry<'projects'>
const loadedProjects = await Promise.all(
	projectEntries.map(([, loader]) => loader() as Promise<CollectionEntry<'projects'>>)
);

// Extraer frontmatter y ordenar por fecha descendente
const projects = loadedProjects
	.map((mod) => mod.frontmatter)
	.filter((project) => project.lang === lang)
	.sort((a, b) => {
		const dateA = new Date(a.date).getTime();
		const dateB = new Date(b.date).getTime();
		return dateB - dateA;
	});

// Paginación
const itemsPerPage = 6;
const totalPages = Math.ceil(projects.length / itemsPerPage);
const start = (currentPage - 1) * itemsPerPage;
const end = start + itemsPerPage;
const projectsToShow = projects.slice(start, end);

const translations: Record<string, { title: string; intro: string }> = {
	es: {
		title: 'Nuestro Portafolio',
		intro:
			'Bienvenido a nuestro espacio de ideas, consejos e inspiración. Descubre artículos pensados para acompañarte en cada etapa de tu camino. ¡Esperamos que disfrutes la lectura!',
	},
	en: {
		title: 'Our Portfolio',
		intro:
			'Welcome to our space of ideas, tips, and inspiration. Discover articles designed to accompany you through every stage of your journey. We hope you enjoy the read!',
	},
};

// Generar rutas estáticas
export async function getStaticPaths() {
	const projectsImport = import.meta.glob('../../../../content/projects/*.mdx');
	const totalPages = Math.ceil(Object.keys(projectsImport).length / 6);

	const paths = [];
	for (let p = 1; p <= totalPages; p++) {
		paths.push({ params: { lang: 'es', page: p.toString() } });
		paths.push({ params: { lang: 'en', page: p.toString() } });
	}

	return paths;
}

const t = translations[lang] ?? translations['es'];
// console.log(projects);
---

<BaseLayout lang={lang}>
	<Banner imageSrc={PortfolioBanner} key="portfolio" lang={lang} />

	<section class="flex flex-col gap-8 px-[5%]">
		<h2 class="text-secondary text-center">{t.title}</h2>
		<p class="text-center">{t.intro}</p>

		<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
			{
				projectsToShow.map((project) => (
					<PortfolioCard
						title={project.title}
						image={project.image}
						date={new Date(project.date).toLocaleDateString(lang === 'es' ? 'es-MX' : 'en-US', {
							weekday: 'short',
							year: 'numeric',
							month: 'short',
							day: 'numeric',
						})}
						slug={project.slug}
						lang={lang}
					/>
				))
			}
		</div>

		<Pagination
			currentPage={currentPage}
			totalPages={totalPages}
			lang={lang}
			basePath="portfolio"
		/>
	</section>

	<CallToAction lang={lang} imageSrc={CTA} />
</BaseLayout>
